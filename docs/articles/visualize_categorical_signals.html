<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualize Categorical Signals • EnrichedHeatmap</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Visualize Categorical Signals">
<meta property="og:description" content="EnrichedHeatmap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EnrichedHeatmap</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.33.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Vignettes</li>
    <li>
      <a href="../articles/EnrichedHeatmap_intro.html">Make Enriched Heatmaps</a>
    </li>
    <li>
      <a href="../articles/visualize_categorical_signals.html">Visualize Categorical Signals</a>
    </li>
    <li>
      <a href="../articles/row_ordering.html">Compare row ordering methods</a>
    </li>
    <li>
      <a href="../articles/roadmap.html">Visualize Comprehensive Associations in Roadmap dataset</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">More applications</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jokergoo/EnrichedHeatmap/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Visualize Categorical Signals</h1>
                        <h4 data-toc-skip class="author">Zuguang Gu ( <a href="mailto:z.gu@dkfz.de" class="email">z.gu@dkfz.de</a> )</h4>
            
            <h4 data-toc-skip class="date">2024-02-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jokergoo/EnrichedHeatmap/blob/HEAD/vignettes/visualize_categorical_signals.Rmd" class="external-link"><code>vignettes/visualize_categorical_signals.Rmd</code></a></small>
      <div class="hidden name"><code>visualize_categorical_signals.Rmd</code></div>

    </div>

    
    
<p>Normally genomic signals are represented as numeric (e.g. methylation from WGBS or histone modification intensity from ChIP-seq) or binary values (e.g. existance of CpG islands in a given position), however, genomic signals sometimes can also be represented as categorical or discrete values (mostly stored as characters). A very typical example is chromatin states segmentation by <a href="http://compbio.mit.edu/ChromHMM/" class="external-link">ChromHMM</a>. ChromHMM basically assigns a chromatin state (e.g. active transcription state or repressive transcription state) to a given window in the genome and the assignment of states in different windows are always mutually exclusive (which means one window can only have one state). In this vignette, We will demonstrate how to visualize the enrichment of various chromatin states around certain genomic targets and how to integerate with other epigenomic signals.</p>
<div class="section level2">
<h2 id="general-examples">General examples<a class="anchor" aria-label="anchor" href="#general-examples"></a>
</h2>
<p>In following example, we use <a href="http://www.roadmapepigenomics.org/" class="external-link">Roadmap dataset</a> as the example dataset. First we show basic usages with using one sample (sample id: E003, embryonic stem cell, H1 cell line).</p>
<p>Load packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/GenomicRanges" class="external-link">GenomicRanges</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/EnrichedHeatmap" class="external-link">EnrichedHeatmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize" class="external-link">circlize</a></span><span class="op">)</span></span></code></pre></div>
<p>The chromatin state segmentation is trained and applied from <a href="http://egg2.wustl.edu/roadmap/web_portal/chr_state_learning.html#core_15state" class="external-link">five histone modifications</a>. Following file in use is from <a href="http://egg2.wustl.edu/roadmap/data/byFileType/chromhmmSegmentations/ChmmModels/coreMarks/jointModel/final/E003_15_coreMarks_mnemonics.bed.gz" class="external-link uri">http://egg2.wustl.edu/roadmap/data/byFileType/chromhmmSegmentations/ChmmModels/coreMarks/jointModel/final/E003_15_coreMarks_mnemonics.bed.gz</a>.</p>
<p>We convert to a <code>GRanges</code> object.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">states_bed</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">"zcat ~/EnrichedHeatmap_test/E003_15_coreMarks_mnemonics.bed.gz"</span><span class="op">)</span></span>
<span><span class="va">states</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html" class="external-link">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="va">states_bed</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, </span>
<span>  ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html" class="external-link">IRanges</a></span><span class="op">(</span><span class="va">states_bed</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">states_bed</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, </span>
<span>  states <span class="op">=</span> <span class="va">states_bed</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">states_bed</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "15_Quies"    "9_Het"       "14_ReprPCWk" "13_ReprPC"   "10_TssBiv"   "7_Enh"      </span></span>
<span><span class="co">##  [7] "1_TssA"      "11_BivFlnk"  "2_TssAFlnk"  "5_TxWk"      "4_Tx"        "8_ZNF/Rpts" </span></span>
<span><span class="co">## [13] "6_EnhG"      "12_EnhBiv"   "3_TxFlnk"</span></span></code></pre>
<p>In the 15 states, there are some states which are similar to each other such as <code>1_TssA</code> (active TSS) and <code>2_TssAFlnk</code> (flanking active TSS). To reduce the complexity of the analysis, we merge some of the similar states.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"1_TssA"</span>      <span class="op">=</span> <span class="st">"TssActive"</span>,</span>
<span>  <span class="st">"2_TssAFlnk"</span>  <span class="op">=</span> <span class="st">"TssActive"</span>,</span>
<span>  <span class="st">"3_TxFlnk"</span>    <span class="op">=</span> <span class="st">"Transcript"</span>,</span>
<span>  <span class="st">"4_Tx"</span>        <span class="op">=</span> <span class="st">"Transcript"</span>,</span>
<span>  <span class="st">"5_TxWk"</span>      <span class="op">=</span> <span class="st">"Transcript"</span>,</span>
<span>  <span class="st">"6_EnhG"</span>      <span class="op">=</span> <span class="st">"Enhancer"</span>,</span>
<span>  <span class="st">"7_Enh"</span>       <span class="op">=</span> <span class="st">"Enhancer"</span>,</span>
<span>  <span class="st">"8_ZNF/Rpts"</span>  <span class="op">=</span> <span class="st">"Heterochromatin"</span>,</span>
<span>  <span class="st">"9_Het"</span>       <span class="op">=</span> <span class="st">"Heterochromatin"</span>,</span>
<span>  <span class="st">"10_TssBiv"</span>   <span class="op">=</span> <span class="st">"TssBivalent"</span>,</span>
<span>  <span class="st">"11_BivFlnk"</span>  <span class="op">=</span> <span class="st">"TssBivalent"</span>,</span>
<span>  <span class="st">"12_EnhBiv"</span>   <span class="op">=</span> <span class="st">"Enhancer"</span>,</span>
<span>  <span class="st">"13_ReprPC"</span>   <span class="op">=</span> <span class="st">"Repressive"</span>,</span>
<span>  <span class="st">"14_ReprPCWk"</span> <span class="op">=</span> <span class="st">"Repressive"</span>,</span>
<span>  <span class="st">"15_Quies"</span>    <span class="op">=</span> <span class="st">"Quiescent"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span> <span class="op">=</span> <span class="va">map</span><span class="op">[</span><span class="va">states</span><span class="op">$</span><span class="va">states</span><span class="op">]</span></span></code></pre></div>
<p>Also we set the colors for the 7 merged states.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">states_col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"TssActive"</span>       <span class="op">=</span> <span class="st">"Red"</span>,</span>
<span>  <span class="st">"Transcript"</span>      <span class="op">=</span> <span class="st">"Green"</span>,</span>
<span>  <span class="st">"Enhancer"</span>        <span class="op">=</span> <span class="st">"Yellow"</span>,</span>
<span>  <span class="st">"Heterochromatin"</span> <span class="op">=</span> <span class="st">"PaleTurquoise"</span>,</span>
<span>  <span class="st">"TssBivalent"</span>     <span class="op">=</span> <span class="st">"Orange"</span>,</span>
<span>  <span class="st">"Repressive"</span>      <span class="op">=</span> <span class="st">"Grey"</span>,</span>
<span>  <span class="st">"Quiescent"</span>       <span class="op">=</span> <span class="st">"black"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">states_name</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">states_col</span><span class="op">)</span></span>
<span><span class="va">n_states</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">states_col</span><span class="op">)</span></span></code></pre></div>
<p>In following, we demonstrate how to normalize the chromatin states to TSS. First we load the transcriptome and extract TSS regions. The transcriptome annotation is from <a href="http://egg2.wustl.edu/roadmap/data/byDataType/rna/annotations/gen10.long.gtf.gz" class="external-link uri">http://egg2.wustl.edu/roadmap/data/byDataType/rna/annotations/gen10.long.gtf.gz</a> and we only use protein coding genes. The database file (the <code>sqlite</code> file) for transcriptome was generated by <strong>GenomicFeatures</strong> package (the <code><a href="https://rdrr.io/pkg/GenomicFeatures/man/makeTxDbFromGFF.html" class="external-link">makeTxDbFromGFF()</a></code> function).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/GenomicFeatures" class="external-link">GenomicFeatures</a></span><span class="op">)</span></span>
<span><span class="va">txdb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/AnnotationDb-class.html" class="external-link">loadDb</a></span><span class="op">(</span><span class="st">"~/EnrichedHeatmap_test/gencode10_protein_coding_txdb.sqlite"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicFeatures/man/transcripts.html" class="external-link">genes</a></span><span class="op">(</span><span class="va">txdb</span><span class="op">)</span></span>
<span><span class="va">tss</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/intra-range-methods.html" class="external-link">promoters</a></span><span class="op">(</span><span class="va">g</span>, upstream <span class="op">=</span> <span class="fl">0</span>, downstream <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>To reduce the running time, here we only use chromosome 1. Normalizing categorical signals is basically as same as numeric signals. Here we only need to specify the column name for the categorical signals.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tss_chr1</span> <span class="op">=</span> <span class="va">tss</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/GenomeInfoDb/man/seqinfo.html" class="external-link">seqnames</a></span><span class="op">(</span><span class="va">tss</span><span class="op">)</span> <span class="op">==</span> <span class="st">"chr1"</span><span class="op">]</span></span>
<span><span class="co"># column "states_simplified" is in character mode</span></span>
<span><span class="va">mat_states</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">tss_chr1</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span><span class="va">mat_states</span></span></code></pre></div>
<pre><code><span><span class="co">## Normalize states to tss_chr1:</span></span>
<span><span class="co">##   Upstream 5000 bp (50 windows)</span></span>
<span><span class="co">##   Downstream 5000 bp (50 windows)</span></span>
<span><span class="co">##   Include target regions (width = 1)</span></span>
<span><span class="co">##   2065 target regions</span></span>
<span><span class="co">##   signal is categorical (7 levels)</span></span></code></pre>
<p>In the last line of the message, it clarifies it is categorical signals with 7 levels.</p>
<p>The implementation of normalizing categorical signals is actually very simple. Internally, <code>n_states</code> normalized matrices are generated where each one corresponds to one chromatin state and the value in each window is the fraction how much the window is overlapped to the state (with <code>w0</code> or <code>weighted</code> mean mode). Since the i^th row and the j^th column in all matrices correspond to a same window to a same target (here the TSS), if there are multiple states overlap to this same window, when summarizing from all states, the state with largest overlap fraction is assigned to this window.</p>
<p>Since the <code><a href="../reference/normalizeToMatrix.html">normalizeToMatrix()</a></code> is called <code>n_states</code> times internally, it will be a little bit slow to normalize to categorical signals.</p>
<p>There are some special visualizations designed for categorical signals where each state is summarized and visualized separatedly in the top annotation. Here <code>states_col</code> must be a named vector where the names should correspond to the levels of the categorical signals.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/categorical_default-1.png" alt=""><p class="caption">plot of chunk categorical_default</p>
</div>
<p>You might feel the row ordering is a little bit in a mess. Although the signals are categorical, internally, there are coded as integer numbers. Just similar as how <strong>factor</strong> in R is stored, each categorical level corresponds to an integer number. If the signal column is simply a character vector, the assignment of integers are based on the natural ordering of this character vector. Thus the numeric coding for signals in <code>states</code> object is:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span><span class="op">)</span>, value <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            states value</span></span>
<span><span class="co">## 1       Quiescent     1</span></span>
<span><span class="co">## 2 Heterochromatin     2</span></span>
<span><span class="co">## 3      Repressive     3</span></span>
<span><span class="co">## 4     TssBivalent     4</span></span>
<span><span class="co">## 5        Enhancer     5</span></span>
<span><span class="co">## 6       TssActive     6</span></span>
<span><span class="co">## 7      Transcript     7</span></span></code></pre>
<p>Zero is assigned to a window if none of the states overlap to it and it is drawn with white.</p>
<p>The numeric coding can be controlled by setting the signals as a factor variable and the level order of the factor controls the corresponding coding. In following code, we convert <code>states_simplified</code> as a factor with specifying the level order.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span>, levels <span class="op">=</span> <span class="va">states_name</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Factor-class.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span><span class="op">)</span>, value <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            states value</span></span>
<span><span class="co">## 1       TssActive     1</span></span>
<span><span class="co">## 2      Transcript     2</span></span>
<span><span class="co">## 3        Enhancer     3</span></span>
<span><span class="co">## 4 Heterochromatin     4</span></span>
<span><span class="co">## 5     TssBivalent     5</span></span>
<span><span class="co">## 6      Repressive     6</span></span>
<span><span class="co">## 7       Quiescent     7</span></span></code></pre>
<p>Note here the order of <code>states_name</code> also reflects the closeness of different states. With the order defined above, <code>TssActive</code> is closer to <code>Transcript</code> and <code>Repressive</code> is closer to <code>Quiescent</code>.</p>
<p>In following left plot, the TSS with active states now are far from the TSS with repressive states. In the right plot we change the level of <code>states_simplified</code> and you can compare to the left one.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mat_states</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">tss_chr1</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span><span class="op">)</span></span>
<span><span class="co"># shuffle levels for states_simplified</span></span>
<span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span>, </span>
<span>  levels <span class="op">=</span> <span class="va">states_name</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">2</span>, <span class="fl">7</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mat_states</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">tss_chr1</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span>, </span>
<span>  row_title <span class="op">=</span> <span class="st">"states_name[c(1, 6, 2, 7, 4, 3, 5)]"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/unnamed-chunk-10-1.png" alt=""><p class="caption">plot of chunk unnamed-chunk-10</p>
</div>
<p>We suggest to apply hierarchical clustering to reorder rows. Here the numeric coding is espeically important because it affects the calculation of distance between rows.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># we change the level back</span></span>
<span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span>, levels <span class="op">=</span> <span class="va">states_name</span><span class="op">)</span></span>
<span><span class="va">mat_states</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">tss_chr1</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span>, cluster_rows <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/categorical_clustered-1.png" alt=""><p class="caption">plot of chunk categorical_clustered</p>
</div>
<p>Since the normalized matrix is numeric, k-means clustering can also be applied.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span>, cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>, row_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/categorical_kmeans-1.png" alt=""><p class="caption">plot of chunk categorical_kmeans</p>
</div>
<p>After closely looking at the heatmap, we found the TSS states are consistently enriched around TSS while in the flanking regions, the states are a little bit diverse. Actually this suggests that in order to enhance the pattern of the TSS-related states, we can apply k-means clustering only for the states near TSS regions.</p>
<p>In following we only cluster the sub-matrix which is upstrean and downstream 1kb of TSS (The default extension of TSS is 5kb upstream and downstream, the number of columns in the normalized matrix is 100, thus from 40^th column to 60^th column are the states in 1kb upstream and downstream of TSS).</p>
<p>Of couse we need to calculate this partitioning in advance.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">mat_states</span><span class="op">[</span>, <span class="fl">40</span><span class="op">:</span><span class="fl">60</span><span class="op">]</span>, centers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span>, cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  row_split <span class="op">=</span> <span class="va">split</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/categorical_partial_kmeans-1.png" alt=""><p class="caption">plot of chunk categorical_partial_kmeans</p>
</div>
<p>Now it is quite nice to see genes with active TSS are all clustered in cluster 2 while in cluster 1, genes are either have no function or have bivalent TSS function.</p>
<p>Similarly, we can visualize how the chromatin states enriched at gene bodies. Since the gene bodies have unequal widths, we add an additional point plot to show the width of genes.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g_chr1</span> <span class="op">=</span> <span class="va">g</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/GenomeInfoDb/man/seqinfo.html" class="external-link">seqnames</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">==</span> <span class="st">"chr1"</span><span class="op">]</span></span>
<span><span class="va">mat_states_2</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">g_chr1</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states_2</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span>, cluster_rows <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html" class="external-link">rowAnnotation</a></span><span class="op">(</span>gene_len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_points.html" class="external-link">anno_points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html" class="external-link">width</a></span><span class="op">(</span><span class="va">g_chr1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>  axis <span class="op">=</span> <span class="cn">TRUE</span>, axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>, </span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"100bp"</span>, <span class="st">"1kb"</span>, <span class="st">"10kb"</span>, <span class="st">"100kb"</span>, <span class="st">"1mb"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/categorical_gene_body-1.png" alt=""><p class="caption">plot of chunk categorical_gene_body</p>
</div>
<p>Next we add methylation around TSS as well as expression for the corresponding genes. Expression data is from <a href="http://egg2.wustl.edu/roadmap/data/byDataType/rna/expression/57epigenomes.RPKM.pc.gz" class="external-link uri">http://egg2.wustl.edu/roadmap/data/byDataType/rna/expression/57epigenomes.RPKM.pc.gz</a> and methylation data is from <a href="http://egg2.wustl.edu/roadmap/data/byDataType/dnamethylation/WGBS/FractionalMethylation.tar.gz" class="external-link uri">http://egg2.wustl.edu/roadmap/data/byDataType/dnamethylation/WGBS/FractionalMethylation.tar.gz</a></p>
<p>In following, the raw methylation data has been smoothed by <strong>bsseq</strong> package. The rds file was generated by the old version of <strong>bsseq</strong> package that is why we used a strange way to extract the positions of CpG sites as well as smoothed methylation data which can be replaced by using <code><a href="https://rdrr.io/pkg/GenomicRanges/man/genomic-range-squeezers.html" class="external-link">granges()</a></code> and <code>getMeth()</code> functions if the smoothing is applied with newest version of <strong>bsseq</strong> package.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="st">"~/EnrichedHeatmap_test/57epigenomes.RPKM.pc.gz"</span>, row.names <span class="op">=</span> <span class="fl">1</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></span>
<span><span class="va">obj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"~/EnrichedHeatmap_test/chr1_roadmap_merged_bsseq.rds"</span><span class="op">)</span></span>
<span><span class="va">meth</span> <span class="op">=</span> <span class="va">obj</span><span class="op">@</span><span class="va">rowData</span></span>
<span><span class="va">meth_mat</span> <span class="op">=</span> <span class="va">obj</span><span class="op">@</span><span class="va">trans</span><span class="op">(</span><span class="va">obj</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">mcols</a></span><span class="op">(</span><span class="va">meth</span><span class="op">)</span> <span class="op">=</span> <span class="va">meth_mat</span></span></code></pre></div>
<p>We take the genes which exist both in <code>tss_chr1</code> and <code>expr</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tss_chr1</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\.\\d+$"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tss_chr1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tss_chr1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tss_chr1</span> <span class="op">=</span> <span class="va">tss_chr1</span><span class="op">[</span><span class="va">cn</span><span class="op">]</span></span>
<span><span class="va">expr</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span><span class="va">cn</span>, <span class="op">]</span></span></code></pre></div>
<p>We normalize chromatin states as well methylation to TSS on chromosome 1.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mat_states</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">tss_chr1</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span><span class="va">mat_meth</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">meth</span>, <span class="va">tss_chr1</span>, value_column <span class="op">=</span> <span class="st">"E003"</span>, mean_mode <span class="op">=</span> <span class="st">"absolute"</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Similarly, k-means is applied on chromatin states 1kb upstream and downstream of TSS. Note since the rows are split into two sub-cluster, we add <code><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_summary.html" class="external-link">anno_summary()</a></code> to the expression matrix to show the distribution of expression in the two sub-clusters.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">mat_states</span><span class="op">[</span>, <span class="fl">40</span><span class="op">:</span><span class="fl">60</span><span class="op">]</span>, centers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span></span>
<span><span class="va">meth_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html" class="external-link">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states</span>, name <span class="op">=</span> <span class="st">"states"</span>, col <span class="op">=</span> <span class="va">states_col</span>, cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  row_split <span class="op">=</span> <span class="va">split</span>, </span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_meth</span>, name <span class="op">=</span> <span class="st">"meth"</span>, col <span class="op">=</span> <span class="va">meth_col_fun</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">expr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tss_chr1</span><span class="op">)</span>, <span class="st">"E003"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"expr"</span>, </span>
<span>  show_row_names <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>summary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/anno_summary.html" class="external-link">anno_summary</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>    outline <span class="op">=</span> <span class="cn">FALSE</span>, axis_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>side <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, ht_gap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/categorical_with_meth-1.png" alt=""><p class="caption">plot of chunk categorical_with_meth</p>
</div>
<p>With corresponding to more epigenomic signals, we can see promoters with active TSS states are always associated with low methylation and high gene expression while promoters annotated as bivalent states or repressed are generally more lowly expressed.</p>
</div>
<div class="section level2">
<h2 id="bivalent-tss">Bivalent TSS<a class="anchor" aria-label="anchor" href="#bivalent-tss"></a>
</h2>
<p>It is believed that in embryonic stem cell, there are a huge number of genes showing bivalency states on promoters. They are called bivalent states because both H3K4me3 which is a histone mark for active transcription and H3K27me3 which is for repressive transcription exist. The loss/gain of active histone mark or repressive histone mark which transite into mature cells is essential for tissue development and differentiation.</p>
<p>To demonstate this, we anlaysis such transitions for one mature tissue (lung tissue, roadmap sample id: E096).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">states_bed</span> <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">"zcat ~/EnrichedHeatmap_test/E096_15_coreMarks_mnemonics.bed.gz"</span><span class="op">)</span></span>
<span><span class="va">states_lung</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html" class="external-link">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="va">states_bed</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html" class="external-link">IRanges</a></span><span class="op">(</span><span class="va">states_bed</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">states_bed</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, </span>
<span>  states <span class="op">=</span> <span class="va">states_bed</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">states_lung</span><span class="op">$</span><span class="va">states_simplified</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">map</span><span class="op">[</span><span class="va">states_lung</span><span class="op">$</span><span class="va">states</span><span class="op">]</span>, levels <span class="op">=</span> <span class="va">states_name</span><span class="op">)</span></span></code></pre></div>
<p>ChromHMM is performed with 200bp window, thus we split whole genome by 200bp window and assign corresponding states to each window, both for ESC and lung.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">window</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeWindows.html">makeWindows</a></span><span class="op">(</span><span class="va">states</span>, w <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">mtch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/findOverlaps-methods.html" class="external-link">findOverlaps</a></span><span class="op">(</span><span class="va">window</span>, <span class="va">states</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">window</span><span class="op">$</span><span class="va">ESC_states</span> <span class="op">=</span> <span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span><span class="op">[</span><span class="va">mtch</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">mtch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/findOverlaps-methods.html" class="external-link">findOverlaps</a></span><span class="op">(</span><span class="va">window</span>, <span class="va">states_lung</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">window</span><span class="op">$</span><span class="va">lung_states</span> <span class="op">=</span> <span class="va">states_lung</span><span class="op">$</span><span class="va">states_simplified</span><span class="op">[</span><span class="va">mtch</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>We only use the windows which are annotated with <code>TssBivalent</code> state either in ESC or in lung.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">window</span> <span class="op">=</span> <span class="va">window</span><span class="op">[</span><span class="va">window</span><span class="op">$</span><span class="va">ESC_states</span> <span class="op">==</span> <span class="st">"TssBivalent"</span> <span class="op">|</span> <span class="va">window</span><span class="op">$</span><span class="va">lung_states</span> <span class="op">==</span> <span class="st">"TssBivalent"</span><span class="op">]</span></span></code></pre></div>
<p>We first make a Chord diagram to show how the transsition happens.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transition_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">mcols</a></span><span class="op">(</span><span class="va">window</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ESC_states"</span>, <span class="st">"lung_states"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fl">200</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">transition_mat</span><span class="op">)</span> <span class="op">=</span> <span class="st">"matrix"</span></span>
<span><span class="va">transition_mat</span> <span class="op">=</span> <span class="va">transition_mat</span><span class="op">[</span><span class="va">states_name</span>, <span class="va">states_name</span><span class="op">]</span></span>
<span><span class="va">transition_mat</span></span></code></pre></div>
<pre><code><span><span class="co">##                  lung_states</span></span>
<span><span class="co">## ESC_states        TssActive Transcript Enhancer Heterochromatin TssBivalent Repressive Quiescent</span></span>
<span><span class="co">##   TssActive               0          0        0               0      136200          0         0</span></span>
<span><span class="co">##   Transcript              0          0        0               0        8200          0         0</span></span>
<span><span class="co">##   Enhancer                0          0        0               0       38800          0         0</span></span>
<span><span class="co">##   Heterochromatin         0          0        0               0       55800          0         0</span></span>
<span><span class="co">##   TssBivalent       4485600     665400  3711800          653000      406000    1799200    766200</span></span>
<span><span class="co">##   Repressive              0          0        0               0       24600          0         0</span></span>
<span><span class="co">##   Quiescent               0          0        0               0       23800          0         0</span></span></code></pre>
<p>The values in the transition matrix mean how many base pairs change from one chromatin state to the other state.</p>
<p>Rows and columns are from different cells, we add prefix to row and column names.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">transition_mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ESC_"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">transition_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">transition_mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"lung_"</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">transition_mat</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we make the Chord diagram.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid.col</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">states_col</span>, <span class="va">states_col</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">grid.col</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">transition_mat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">transition_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/circlize/man/chordDiagram.html" class="external-link">chordDiagram</a></span><span class="op">(</span><span class="va">transition_mat</span>, grid.col <span class="op">=</span> <span class="va">grid.col</span>, annotationTrack <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grid"</span>, <span class="st">"axis"</span><span class="op">)</span>,</span>
<span>  directional <span class="op">=</span> <span class="cn">TRUE</span>, gap.degree <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/circlize/man/circos.clear.html" class="external-link">circos.clear</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">1</span>, <span class="st">"ESC"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="st">"lung"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"left"</span>, pch <span class="op">=</span> <span class="fl">15</span>, col <span class="op">=</span> <span class="va">states_col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">states_col</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/tssbiv_chord_diagram-1.png" alt=""><p class="caption">plot of chunk tssbiv_chord_diagram</p>
</div>
<p>As we can see from the Chord diagram, a lot of regions with bivalent TSS states (orange track at bottom) have been tansite to active (red track on top) or repressive states (grey track on top) in lung.</p>
<p>To get more deep of how the transistion looks like, we can make enriched heatmaps to see the associations between different epigenomic signals.</p>
<p>Since <code>TssBivalent</code> states basically are states for TSS related regions, we only keep genes for which in 1kb upstream and downstream of TSS there must be a window with TssBivalent state. Again, we only use chromosome 1 as demonstration.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mat_bivtss</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span><span class="op">[</span><span class="va">states</span><span class="op">$</span><span class="va">states_simplified</span> <span class="op">==</span> <span class="st">"TssBivalent"</span><span class="op">]</span>, <span class="va">tss_chr1</span><span class="op">)</span></span>
<span><span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">mat_bivtss</span><span class="op">[</span>, <span class="fl">40</span><span class="op">:</span><span class="fl">60</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="co"># 1kb upstream and downstream</span></span>
<span><span class="va">tss_biv</span> <span class="op">=</span> <span class="va">tss_chr1</span><span class="op">[</span><span class="va">l</span><span class="op">]</span></span>
<span><span class="va">tss_biv</span></span></code></pre></div>
<pre><code><span><span class="co">## GRanges object with 443 ranges and 1 metadata column:</span></span>
<span><span class="co">##                   seqnames                 ranges strand |           gene_id</span></span>
<span><span class="co">##                      &lt;Rle&gt;              &lt;IRanges&gt;  &lt;Rle&gt; |       &lt;character&gt;</span></span>
<span><span class="co">##   ENSG00000000938     chr1 [ 27961788,  27961788]      - | ENSG00000000938.8</span></span>
<span><span class="co">##   ENSG00000006555     chr1 [ 55266940,  55266940]      - | ENSG00000006555.6</span></span>
<span><span class="co">##   ENSG00000007968     chr1 [ 23857712,  23857712]      - | ENSG00000007968.6</span></span>
<span><span class="co">##   ENSG00000008118     chr1 [209757062, 209757062]      + | ENSG00000008118.5</span></span>
<span><span class="co">##   ENSG00000009709     chr1 [ 18957500,  18957500]      + | ENSG00000009709.7</span></span>
<span><span class="co">##               ...      ...                    ...    ... .               ...</span></span>
<span><span class="co">##   ENSG00000243749     chr1 [ 35450954,  35450954]      - | ENSG00000243749.1</span></span>
<span><span class="co">##   ENSG00000248485     chr1 [161228517, 161228517]      + | ENSG00000248485.1</span></span>
<span><span class="co">##   ENSG00000249087     chr1 [ 23695711,  23695711]      + | ENSG00000249087.3</span></span>
<span><span class="co">##   ENSG00000251246     chr1 [155036224, 155036224]      + | ENSG00000251246.1</span></span>
<span><span class="co">##   ENSG00000253304     chr1 [ 29450447,  29450447]      - | ENSG00000253304.1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 25 sequences from an unspecified genome; no seqlengths</span></span></code></pre>
<p>We normalize chromatin states and methylation to <code>tss_biv</code>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mat_states_ESC</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">tss_biv</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span><span class="va">mat_states_lung</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">states_lung</span>, <span class="va">tss_biv</span>, value_column <span class="op">=</span> <span class="st">"states_simplified"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mat_meth_ESC</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">meth</span>, <span class="va">tss_biv</span>, value_column <span class="op">=</span> <span class="st">"E003"</span>, mean_mode <span class="op">=</span> <span class="st">"absolute"</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">mat_meth_lung</span> <span class="op">=</span> <span class="fu"><a href="../reference/normalizeToMatrix.html">normalizeToMatrix</a></span><span class="op">(</span><span class="va">meth</span>, <span class="va">tss_biv</span>, value_column <span class="op">=</span> <span class="st">"E096"</span>, mean_mode <span class="op">=</span> <span class="st">"absolute"</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Normally, methylation changes happen at the border of low methylation region. To enhance the effect of methylation change, we directly visualize the methyaltion difference.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mat_meth_diff</span> <span class="op">=</span> <span class="va">mat_meth_ESC</span> <span class="op">-</span> <span class="va">mat_meth_lung</span></span>
<span><span class="va">meth_diff_col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html" class="external-link">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#3794bf"</span>, <span class="st">"#FFFFFF"</span>, <span class="st">"#df8640"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we construct the heatmap list.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states_ESC</span>, name <span class="op">=</span> <span class="st">"states_ESC"</span>, col <span class="op">=</span> <span class="va">states_col</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  column_title <span class="op">=</span> <span class="st">"States ESC"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_states_lung</span>, name <span class="op">=</span> <span class="st">"states_lung"</span>, col <span class="op">=</span> <span class="va">states_col</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  show_heatmap_legend <span class="op">=</span> <span class="cn">FALSE</span>, column_title <span class="op">=</span> <span class="st">"States lung"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ht_list</span> <span class="op">=</span> <span class="va">ht_list</span> <span class="op">+</span> <span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_meth_ESC</span>, name <span class="op">=</span> <span class="st">"meth_ESC"</span>, col <span class="op">=</span> <span class="va">meth_col_fun</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  column_title <span class="op">=</span> <span class="st">"Meth ESC"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_meth_lung</span>, name <span class="op">=</span> <span class="st">"meth_lung"</span>, col <span class="op">=</span> <span class="va">meth_col_fun</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, </span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  show_heatmap_legend <span class="op">=</span> <span class="cn">FALSE</span>, column_title <span class="op">=</span> <span class="st">"Meth lung"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_meth_diff</span>, name <span class="op">=</span> <span class="st">"meth_diff"</span>, col <span class="op">=</span> <span class="va">meth_diff_col_fun</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, </span>
<span>    pos_col <span class="op">=</span> <span class="st">"#df8640"</span>, neg_col <span class="op">=</span> <span class="st">"#3794bf"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  column_title <span class="op">=</span> <span class="st">"Meth ESC - lung"</span><span class="op">)</span></span></code></pre></div>
<p>Actually we can discretize the numeric <code>mat_meth_diff</code>. Here we assign <code>hyper</code> to windows with methylation difference larger than 0.2 and <code>hypo</code> to windows with methylation difference less than -0.2. Here <code><a href="../reference/discretize.html">discretize()</a></code> converts a matrix with continuous signals to categorical signals by prividing a list of intervals.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mat_meth_diff_discrete</span> <span class="op">=</span> <span class="fu"><a href="../reference/discretize.html">discretize</a></span><span class="op">(</span><span class="va">mat_meth_diff</span>,</span>
<span>  rule <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"hypo"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>,</span>
<span>    <span class="st">"hyper"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mat_meth_diff_discrete</span></span></code></pre></div>
<pre><code><span><span class="co">## Normalize  to tss_biv:</span></span>
<span><span class="co">##   Upstream 5000 bp (50 windows)</span></span>
<span><span class="co">##   Downstream 5000 bp (50 windows)</span></span>
<span><span class="co">##   Include target regions (width = 1)</span></span>
<span><span class="co">##   443 target regions</span></span>
<span><span class="co">##   signal is categorical (2 levels)</span></span></code></pre>
<p>We continue to add more heatmaps.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ht_list</span> <span class="op">=</span> <span class="va">ht_list</span> <span class="op">+</span> <span class="fu"><a href="../reference/EnrichedHeatmap.html">EnrichedHeatmap</a></span><span class="op">(</span><span class="va">mat_meth_diff_discrete</span>, name <span class="op">=</span> <span class="st">"meth_diff_discrete"</span>, </span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hyper"</span> <span class="op">=</span> <span class="st">"#df8640"</span>, hypo <span class="op">=</span> <span class="st">"#3794bf"</span><span class="op">)</span>,</span>
<span>  top_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>enrich <span class="op">=</span> <span class="fu"><a href="../reference/anno_enriched.html">anno_enriched</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally the heatmap for gene expression.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">e</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">expr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tss_biv</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"E003"</span>, <span class="st">"E096"</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ht_list</span> <span class="op">=</span> <span class="va">ht_list</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">e</span>, name <span class="op">=</span> <span class="st">"expr"</span>, </span>
<span>  show_row_names <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">"mm"</span><span class="op">)</span>, cluster_columns <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The row ordering for all heatmaps is from hierarchical clustering on the merged matrix from states in ESC and lung, 1kb upstream and downstream of TSS.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">row_order</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html" class="external-link">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">mat_states_ESC</span><span class="op">[</span>, <span class="fl">40</span><span class="op">:</span><span class="fl">60</span><span class="op">]</span>, <span class="va">mat_states_lung</span><span class="op">[</span>, <span class="fl">40</span><span class="op">:</span><span class="fl">60</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">order</span></span>
<span><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">e</span><span class="op">[</span>, <span class="st">"E096"</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">e</span><span class="op">[</span>, <span class="st">"E003"</span><span class="op">]</span>, <span class="st">"activation"</span>, <span class="st">"repression"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw</a></span><span class="op">(</span><span class="va">ht_list</span>, row_order <span class="op">=</span> <span class="va">row_order</span>, row_split <span class="op">=</span> <span class="va">split</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="image/categorical_with_lung-1.png" alt=""><p class="caption">plot of chunk categorical_with_lung</p>
</div>
<p>What conclusion can you make from the plot? I can only say the regulation pattern is really complicated there :).</p>
</div>
<div class="section level2">
<h2 id="other-examples">Other examples<a class="anchor" aria-label="anchor" href="#other-examples"></a>
</h2>
<p>There are some other examples where the genomic signals are categorical.</p>
<ol style="list-style-type: decimal">
<li>repeats where different repeat family can be different categories,</li>
<li>genome segmentation based on methylation. E.g. hign methylated regions (HMRs), partially methylated regions (PMDs), low methylated regions (LMRs), unmethylated regions (UMRs),</li>
<li>for gene-related regions, genic annotation is also categorical.</li>
</ol>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 3.3.1 (2016-06-21)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: openSUSE 13.1 (Bottle) (x86_64)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_GB.UTF-8       LC_NUMERIC=C               LC_TIME=en_GB.UTF-8       </span></span>
<span><span class="co">##  [4] LC_COLLATE=en_GB.UTF-8     LC_MONETARY=en_GB.UTF-8    LC_MESSAGES=en_GB.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_GB.UTF-8       LC_NAME=C                  LC_ADDRESS=C              </span></span>
<span><span class="co">## [10] LC_TELEPHONE=C             LC_MEASUREMENT=en_GB.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">##  [1] grid      parallel  stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [10] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] GenomicFeatures_1.26.4 AnnotationDbi_1.36.2   Biobase_2.34.0         circlize_0.4.5        </span></span>
<span><span class="co">##  [5] EnrichedHeatmap_1.13.1 ComplexHeatmap_1.99.0  data.table_1.10.4      GenomicRanges_1.26.4  </span></span>
<span><span class="co">##  [9] GenomeInfoDb_1.10.3    IRanges_2.8.2          S4Vectors_0.12.2       BiocGenerics_0.20.0   </span></span>
<span><span class="co">## [13] markdown_0.8           knitr_1.20             colorout_1.2-0        </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] Rcpp_0.12.18               highr_0.7                  RColorBrewer_1.1-2        </span></span>
<span><span class="co">##  [4] XVector_0.14.1             bitops_1.0-6               tools_3.3.1               </span></span>
<span><span class="co">##  [7] zlibbioc_1.20.0            biomaRt_2.30.0             evaluate_0.11             </span></span>
<span><span class="co">## [10] RSQLite_1.0.0              lattice_0.20-34            png_0.1-7                 </span></span>
<span><span class="co">## [13] Matrix_1.2-7.1             DBI_1.0.0                  rtracklayer_1.34.2        </span></span>
<span><span class="co">## [16] stringr_1.3.1              Biostrings_2.42.1          GlobalOptions_0.1.0       </span></span>
<span><span class="co">## [19] locfit_1.5-9.1             GetoptLong_0.1.7           BiocParallel_1.8.2        </span></span>
<span><span class="co">## [22] XML_3.98-1.16              magrittr_1.5               GenomicAlignments_1.10.1  </span></span>
<span><span class="co">## [25] Rsamtools_1.26.2           matrixStats_0.54.0         SummarizedExperiment_1.4.0</span></span>
<span><span class="co">## [28] shape_1.4.4                colorspace_1.3-2           stringi_1.2.4             </span></span>
<span><span class="co">## [31] RCurl_1.95-4.8             rjson_0.2.20</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Zuguang Gu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  <style>nav[data-toggle='toc'] .nav .nav {display: block;}</style>
</body>
</html>
